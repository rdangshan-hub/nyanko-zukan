<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>にゃんこ図鑑 Pro 完全版</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="にゃんこ図鑑">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    body { background:#121212; color:#fff; font-family:sans-serif; margin:0; padding:0; }
    header { display:flex; justify-content:space-between; align-items:center; padding:10px; background:#1e1e1e; }
    header h1 { font-size:18px; margin:0; }
    nav button { margin:0 5px; padding:6px 12px; font-size:14px; }
    .hidden { display:none; }
    .form-section { border:1px solid #444; padding:10px; margin:10px 0; }
    input, select, textarea { width:100%; margin:4px 0; padding:4px; background:#1e1e1e; color:#fff; border:1px solid #555; }
    .form-actions { position:sticky; top:0; background:#121212; padding:10px; z-index:10; }
    .catalog-list { margin:10px; }
    .catalog-item { border:1px solid #444; padding:8px; margin:5px 0; display:flex; justify-content:space-between; align-items:center; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,100px); gap:10px; margin:10px; }
    .grid-item { width:100px; text-align:center; }
    .grid-item img { width:100px; height:100px; object-fit:cover; background:#333; }
    .modal { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; }
    .modal-content { background:#1e1e1e; padding:20px; max-width:600px; max-height:90%; overflow:auto; }
    .dark-toggle { cursor:pointer; }
    .traits { margin:5px 0; }
  </style>
</head>
<body>
<header>
  <h1>にゃんこ図鑑 Pro</h1>
  <div>
    <button onclick="showTab('register')">登録</button>
    <button onclick="showTab('catalog')">図鑑</button>
    <button onclick="showTab('trash')">ゴミ箱</button>
    <button class="dark-toggle" onclick="toggleDark()">🌙/☀️</button>
  </div>
</header>

<main>
  <!-- 登録画面 -->
  <section id="register">
    <div class="form-actions">
      <button onclick="saveCharacter()">保存</button>
    </div>
    <h2>キャラ登録</h2>
    <label>No:<input type="number" id="charNo"></label>
    <div>
      レアリティ:
      <label><input type="checkbox" class="rarity" value="基本">基本</label>
      <label><input type="checkbox" class="rarity" value="EX">EX</label>
      <label><input type="checkbox" class="rarity" value="レア">レア</label>
      <label><input type="checkbox" class="rarity" value="激レア">激レア</label>
      <label><input type="checkbox" class="rarity" value="超激レア">超激レア</label>
      <label><input type="checkbox" class="rarity" value="伝説レア">伝説レア</label>
    </div>
    <div>
      表示単位:
      <select id="unitMode">
        <option value="sec">秒</option>
        <option value="30fps">30fps(iOS)</option>
        <option value="27fps">27fps(Android)</option>
      </select>
    </div>

    <!-- 形態入力 -->
    <div id="forms"></div>
  </section>

  <!-- 図鑑画面 -->
  <section id="catalog" class="hidden">
    <h2>図鑑</h2>
    <div>
      <input type="text" id="searchName" placeholder="名前検索" oninput="renderCatalog()">
      <label><input type="checkbox" onchange="toggleGridNumber(this)">グリッド番号表示</label>
    </div>
    <div>
      レアリティ絞り込み:
      <label><input type="checkbox" class="filterRarity" value="基本" onchange="renderCatalog()">基本</label>
      <label><input type="checkbox" class="filterRarity" value="EX" onchange="renderCatalog()">EX</label>
      <label><input type="checkbox" class="filterRarity" value="レア" onchange="renderCatalog()">レア</label>
      <label><input type="checkbox" class="filterRarity" value="激レア" onchange="renderCatalog()">激レア</label>
      <label><input type="checkbox" class="filterRarity" value="超激レア" onchange="renderCatalog()">超激レア</label>
      <label><input type="checkbox" class="filterRarity" value="伝説レア" onchange="renderCatalog()">伝説レア</label>
    </div>
    <button onclick="toggleView()">リスト/グリッド切替</button>
    <div id="catalogList" class="catalog-list"></div>
    <div id="catalogGrid" class="grid hidden"></div>
  </section>

  <!-- ゴミ箱 -->
  <section id="trash" class="hidden">
    <h2>ゴミ箱</h2>
    <div id="trashList"></div>
  </section>
</main>

<!-- 詳細モーダル -->
<div id="detailModal" class="modal" onclick="closeModal(event)">
  <div class="modal-content" id="modalContent"></div>
</div>

<script>
let characters = JSON.parse(localStorage.getItem("nyanko")||"[]");
let trash = JSON.parse(localStorage.getItem("nyankoTrash")||"[]");
let editIndex = null;
let viewMode = "list";
let showGridNo = false;

function showTab(id){
  document.querySelectorAll("main>section").forEach(s=>s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  if(id==="catalog") renderCatalog();
  if(id==="trash") renderTrash();
  if(id==="register") renderForm();
}

function renderForm(){
  const container=document.getElementById("forms");
  container.innerHTML="";
  for(let i=1;i<=4;i++){
    container.innerHTML+=`
      <div class="form-section">
        <h3>第${i}形態</h3>
        <label>名前:<input id="form${i}Name"></label>
        <label>説明:<textarea id="form${i}Desc"></textarea></label>
        <label>画像:<input type="file" accept="image/*" onchange="previewImage(event,'form${i}Img')"></label>
        <img id="form${i}Img" style="max-width:100px;display:block;margin:5px 0;">
        <label>HP:<input type="number" id="form${i}HP"></label>
        <label>攻撃力:<input type="number" id="form${i}Atk"></label>
        <label>DPS:<input type="number" id="form${i}DPS" placeholder="自動計算"></label>
        <label>射程:<input type="number" id="form${i}Range"></label>
        <label>コスト:<input type="number" id="form${i}Cost"></label>
        <label>KB:<input type="number" id="form${i}KB"></label>
        <label>移動速度:<input type="number" id="form${i}Speed"></label>
        <label>再生産:<input type="number" id="form${i}Respawn"></label>
        <label>攻撃発生:<input type="number" id="form${i}AttackStart"></label>
        <label>攻撃頻度:<input type="number" id="form${i}AttackFreq"></label>
        <div class="traits" id="traits${i}">
          <h4>特性</h4>
          <button type="button" onclick="addTrait(${i})">特性追加</button>
        </div>
      </div>`;
  }
}

function previewImage(e,id){
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=()=>{document.getElementById(id).src=reader.result;};
  reader.readAsDataURL(file);
}

function addTrait(form){
  const d=document.createElement("div");
  d.innerHTML=`
    <input placeholder="特性名">
    <input type="number" placeholder="確率%">
    <input type="number" placeholder="効果時間(s)">
    <input placeholder="属性">
  `;
  document.getElementById("traits"+form).appendChild(d);
}

function saveCharacter(){
  const char={ no:document.getElementById("charNo").value, rarity:[...document.querySelectorAll(".rarity:checked")].map(r=>r.value), forms:[] };
  for(let i=1;i<=4;i++){
    const atk=+document.getElementById(`form${i}Atk`).value||0;
    const freq=+document.getElementById(`form${i}AttackFreq`).value||0;
    let dps=document.getElementById(`form${i}DPS`).value;
    if(!dps && atk && freq) dps=Math.floor(atk/freq);
    const traits=[...document.querySelectorAll(`#traits${i} div`)].map(t=>{
      const inp=t.querySelectorAll("input");
      return {name:inp[0].value,chance:inp[1].value,duration:inp[2].value,attribute:inp[3].value};
    });
    char.forms.push({
      name:document.getElementById(`form${i}Name`).value,
      desc:document.getElementById(`form${i}Desc`).value,
      img:document.getElementById(`form${i}Img`).src,
      hp:document.getElementById(`form${i}HP`).value,
      atk, dps,
      range:document.getElementById(`form${i}Range`).value,
      cost:document.getElementById(`form${i}Cost`).value,
      kb:document.getElementById(`form${i}KB`).value,
      speed:document.getElementById(`form${i}Speed`).value,
      respawn:document.getElementById(`form${i}Respawn`).value,
      attackStart:document.getElementById(`form${i}AttackStart`).value,
      attackFreq:freq,
      traits
    });
  }
  if(editIndex!==null){ characters[editIndex]=char; editIndex=null; } else characters.push(char);
  localStorage.setItem("nyanko",JSON.stringify(characters));
  showTab("catalog");
}

function renderCatalog(){
  const list=document.getElementById("catalogList");
  const grid=document.getElementById("catalogGrid");
  list.innerHTML=""; grid.innerHTML="";
  const search=document.getElementById("searchName").value;
  const rarities=[...document.querySelectorAll(".filterRarity:checked")].map(r=>r.value);
  const filtered=characters.filter(c=>{
    const nameMatch=c.forms[0].name.includes(search);
    const rarityMatch=rarities.length?c.rarity.some(r=>rarities.includes(r)):true;
    return nameMatch && rarityMatch;
  });
  if(viewMode==="list"){
    list.classList.remove("hidden"); grid.classList.add("hidden");
    filtered.forEach((c,i)=>{
      const div=document.createElement("div");
      div.className="catalog-item";
      div.innerHTML=`No.${c.no} ${c.forms[0].name}
        <span>
        <button onclick="editChar(${i})">編集</button>
        <button onclick="delChar(${i})">削除</button>
        </span>`;
      list.appendChild(div);
    });
  }else{
    grid.classList.remove("hidden"); list.classList.add("hidden");
    filtered.forEach((c,i)=>{
      const div=document.createElement("div");
      div.className="grid-item";
      div.innerHTML=`<img src="${c.forms[0].img||''}" onclick="showDetail(${i})">${showGridNo?`<div>No.${c.no}</div>`:""}`;
      grid.appendChild(div);
    });
  }
}

function toggleView(){ viewMode=viewMode==="list"?"grid":"list"; renderCatalog(); }
function toggleGridNumber(cb){ showGridNo=cb.checked; renderCatalog(); }

function editChar(i){ editIndex=i; showTab("register"); const c=characters[i]; document.getElementById("charNo").value=c.no;
  document.querySelectorAll(".rarity").forEach(r=>r.checked=c.rarity.includes(r.value)); renderForm();
  c.forms.forEach((f,idx)=>{ const i2=idx+1;
    document.getElementById(`form${i2}Name`).value=f.name;
    document.getElementById(`form${i2}Desc`).value=f.desc;
    if(f.img) document.getElementById(`form${i2}Img`).src=f.img;
    document.getElementById(`form${i2}HP`).value=f.hp;
    document.getElementById(`form${i2}Atk`).value=f.atk;
    document.getElementById(`form${i2}DPS`).value=f.dps;
    document.getElementById(`form${i2}Range`).value=f.range;
    document.getElementById(`form${i2}Cost`).value=f.cost;
    document.getElementById(`form${i2}KB`).value=f.kb;
    document.getElementById(`form${i2}Speed`).value=f.speed;
    document.getElementById(`form${i2}Respawn`).value=f.respawn;
    document.getElementById(`form${i2}AttackStart`).value=f.attackStart;
    document.getElementById(`form${i2}AttackFreq`).value=f.attackFreq;
    f.traits.forEach(t=>{addTrait(i2);const d=document.querySelectorAll(`#traits${i2} div`);const inp=d[d.length-1].querySelectorAll("input");
      inp[0].value=t.name;inp[1].value=t.chance;inp[2].value=t.duration;inp[3].value=t.attribute;});
  });
}

function delChar(i){ const c=characters.splice(i,1)[0]; c.deleted=Date.now(); trash.push(c);
  localStorage.setItem("nyanko",JSON.stringify(characters)); localStorage.setItem("nyankoTrash",JSON.stringify(trash)); renderCatalog();
}

function renderTrash(){ const d=document.getElementById("trashList"); d.innerHTML=""; const now=Date.now();
  trash=trash.filter(c=>now-c.deleted<7*24*60*60*1000);
  localStorage.setItem("nyankoTrash",JSON.stringify(trash));
  trash.forEach((c,i)=>{const div=document.createElement("div");div.className="catalog-item";
    div.innerHTML=`No.${c.no} ${c.forms[0].name}
    <button onclick="restore(${i})">復元</button>
    <button onclick="erase(${i})">完全削除</button>`;
    d.appendChild(div);});
}
function restore(i){ characters.push(trash.splice(i,1)[0]); saveAll(); renderTrash(); }
function erase(i){ trash.splice(i,1); saveAll(); renderTrash(); }
function saveAll(){ localStorage.setItem("nyanko",JSON.stringify(characters)); localStorage.setItem("nyankoTrash",JSON.stringify(trash)); }

function showDetail(i){ const m=document.getElementById("detailModal");const c=characters[i];
  let html=`<h3>No.${c.no} ${c.forms[0].name}</h3>`;c.forms.forEach((f,idx)=>{html+=`<h4>第${idx+1}形態 ${f.name}</h4><img src="${f.img||''}" style="max-width:150px;"><p>${f.desc}</p>
  <ul><li>HP:${f.hp}</li><li>攻撃:${f.atk}</li><li>DPS:${f.dps}</li><li>射程:${f.range}</li><li>コスト:${f.cost}</li><li>KB:${f.kb}</li><li>速度:${f.speed}</li><li>再生産:${f.respawn}</li><li>攻撃発生:${f.attackStart}</li><li>攻撃頻度:${f.attackFreq}</li></ul>`;
  if(f.traits.length){html+="<h5>特性</h5><ul>";f.traits.forEach(t=>{html+=`<li>${t.name} 確率:${t.chance}% 時間:${t.duration}s 属性:${t.attribute}</li>`});html+="</ul>";}});
  html+=`<button onclick="editChar(${i})">編集</button> <button onclick="delChar(${i})">削除</button>`;
  document.getElementById("modalContent").innerHTML=html; m.style.display="flex";
}
function closeModal(e){ if(e.target.classList.contains("modal")) e.target.style.display="none"; }

function toggleDark(){document.body.classList.toggle("light");}
</script>
</body>
</html>
