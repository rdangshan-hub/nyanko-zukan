<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>にゃんこ図鑑 Pro 完全版</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="にゃんこ図鑑">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    body { background:#121212; color:#fff; font-family:sans-serif; margin:0; }
    header { display:flex; justify-content:space-between; align-items:center;
             background:#1e1e1e; padding:10px; }
    header h1 { font-size:18px; margin:0; }
    button { padding:6px 12px; margin:2px; border:none; border-radius:4px; cursor:pointer; }
    .dark button { background:#333; color:#fff; }
    .tab { display:none; padding:10px; }
    .active { display:block; }
    input, select, textarea { background:#1e1e1e; color:#fff; border:1px solid #555; border-radius:4px; padding:4px; margin:2px 0; }
    .catalog-list .card { background:#1e1e1e; border:1px solid #444; padding:10px; margin:5px 0; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,100px); gap:10px; }
    .grid .icon { width:100px; height:100px; background:#333; display:flex; align-items:center; justify-content:center; position:relative; }
    .grid .icon img { max-width:100%; max-height:100%; object-fit:cover; }
    .grid .num { text-align:center; font-size:12px; margin-top:2px; }
    .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; }
    .modal-content { background:#1e1e1e; padding:20px; border-radius:6px; max-height:90%; overflow:auto; }
  </style>
</head>
<body class="dark">
<header>
  <h1>にゃんこ図鑑 Pro</h1>
  <div>
    <button onclick="showTab('register')">登録</button>
    <button onclick="showTab('catalog')">図鑑</button>
    <button onclick="showTab('trash')">ゴミ箱</button>
    <button onclick="toggleDark()">🌙/☀️</button>
  </div>
</header>

<!-- 登録タブ -->
<div id="register" class="tab active">
  <h2>キャラ登録 / 編集</h2>
  <form id="catForm">
    <label>No:<input type="number" id="catNo"></label><br>
    <label>名前:<input type="text" id="catName"></label><br>
    <div id="formsContainer"></div>
    <button type="submit" id="saveBtn">保存</button>
  </form>
</div>

<!-- 図鑑タブ -->
<div id="catalog" class="tab">
  <h2>図鑑</h2>
  <div>
    <input type="text" id="searchName" placeholder="名前検索">
    <input type="text" id="searchTrait" placeholder="特性検索">
    <label><input type="checkbox" id="rarityBasic">基本</label>
    <label><input type="checkbox" id="rarityEX">EX</label>
    <label><input type="checkbox" id="rarityRare">レア</label>
    <label><input type="checkbox" id="raritySuper">激レア</label>
    <label><input type="checkbox" id="rarityUber">超激レア</label>
    <label><input type="checkbox" id="rarityLegend">伝説レア</label>
    <select id="andOr">
      <option value="AND">AND</option>
      <option value="OR">OR</option>
    </select>
    <label><input type="checkbox" id="gridNumToggle">番号を表示</label>
    <button onclick="toggleView('list')">リスト</button>
    <button onclick="toggleView('grid')">グリッド</button>
  </div>
  <div id="catalogList" class="catalog-list"></div>
  <div id="catalogGrid" class="grid" style="display:none;"></div>
</div>

<!-- ゴミ箱タブ -->
<div id="trash" class="tab">
  <h2>ゴミ箱</h2>
  <div id="trashList"></div>
</div>

<!-- 詳細モーダル -->
<div id="modal" class="modal" onclick="closeModal(event)">
  <div class="modal-content" id="modalContent"></div>
</div>

<script>
let cats = JSON.parse(localStorage.getItem('cats')||'[]');
let trash = JSON.parse(localStorage.getItem('trash')||'[]');
let editIndex = null;
let currentView = 'list';

function showTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='catalog') renderCatalog();
  if(id==='trash') renderTrash();
}

function toggleDark(){
  document.body.classList.toggle('dark');
}

function toggleView(v){
  currentView=v;
  document.getElementById('catalogList').style.display=(v==='list')?'block':'none';
  document.getElementById('catalogGrid').style.display=(v==='grid')?'grid':'none';
  renderCatalog();
}

function renderCatalog(){
  const list=document.getElementById('catalogList');
  const grid=document.getElementById('catalogGrid');
  list.innerHTML=''; grid.innerHTML='';
  cats.forEach((c,i)=>{
    // リスト表示
    if(currentView==='list'){
      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`No.${c.no||''} ${c.name||''} <button onclick="editCat(${i})">編集</button> <button onclick="deleteCat(${i})">削除</button>`;
      list.appendChild(card);
    } else {
      // グリッド表示
      const wrap=document.createElement('div'); wrap.className='icon';
      const img=document.createElement('img'); img.src=c.forms[0]?.image||'';
      wrap.appendChild(img);
      wrap.onclick=()=>showModal(i);
      grid.appendChild(wrap);
      if(document.getElementById('gridNumToggle').checked){
        const num=document.createElement('div'); num.className='num'; num.textContent="No."+ (c.no||'');
        grid.appendChild(num);
      }
    }
  });
}

function renderTrash(){
  const list=document.getElementById('trashList');
  list.innerHTML='';
  trash=trash.filter(t=> Date.now()-t.deletedAt < 7*24*60*60*1000 );
  localStorage.setItem('trash',JSON.stringify(trash));
  trash.forEach((c,i)=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`No.${c.no||''} ${c.name||''} <button onclick="restoreCat(${i})">復元</button> <button onclick="purgeCat(${i})">完全削除</button>`;
    list.appendChild(card);
  });
}

function editCat(i){
  editIndex=i;
  const c=cats[i];
  document.getElementById('catNo').value=c.no||'';
  document.getElementById('catName').value=c.name||'';
  showTab('register');
}

function deleteCat(i){
  trash.push({...cats[i], deletedAt:Date.now()});
  cats.splice(i,1);
  saveData();
  renderCatalog();
}

function restoreCat(i){
  cats.push(trash[i]);
  trash.splice(i,1);
  saveData();
  renderTrash();
}

function purgeCat(i){
  trash.splice(i,1);
  saveData();
  renderTrash();
}

function saveData(){
  localStorage.setItem('cats',JSON.stringify(cats));
  localStorage.setItem('trash',JSON.stringify(trash));
}

function showModal(i){
  const c=cats[i];
  const m=document.getElementById('modalContent');
  m.innerHTML=`<h3>No.${c.no||''} ${c.name}</h3><button onclick="editCat(${i})">編集</button><button onclick="deleteCat(${i})">削除</button>`;
  document.getElementById('modal').style.display='flex';
}

function closeModal(e){
  if(e.target.id==='modal') document.getElementById('modal').style.display='none';
}

document.getElementById('catForm').onsubmit=e=>{
  e.preventDefault();
  const c={ no:document.getElementById('catNo').value, name:document.getElementById('catName').value, forms:[{image:''}] };
  if(editIndex!==null){ cats[editIndex]=c; editIndex=null; } else { cats.push(c); }
  saveData();
  showTab('catalog');
};
</script>
</body>
</html>