<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>にゃんこ図鑑 Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- ホーム画面追加用 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="にゃんこ図鑑">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    body { font-family: -apple-system, sans-serif; margin: 0; }
    header { background:#222; color:#fff; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { font-size:18px; margin:0; }
    nav button { margin:0 4px; }
    #unit-select { margin-left:10px; }
    .tab { display:none; padding:10px; }
    .tab.active { display:block; }
    .form-block { border:1px solid #ccc; padding:8px; margin:8px 0; border-radius:6px; }
    .row { display:flex; flex-wrap:wrap; gap:6px; margin:4px 0; }
    .row input, .row select, .row textarea { flex:1; min-width:120px; }
    .cat-card { border:1px solid #aaa; border-radius:6px; margin:6px 0; padding:6px; display:flex; justify-content:space-between; align-items:center; }
    .cat-card img { width:50px; height:50px; object-fit:cover; border-radius:6px; margin-right:6px; }
    .traits { margin-top:6px; font-size:13px; }
    .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
    .modal-content { background:#fff; padding:16px; border-radius:8px; width:90%; max-width:600px; max-height:90%; overflow:auto; }
    .tab-btn.active { background:#222; color:#fff; }
  </style>
</head>
<body>
  <header>
    <h1>🐱 にゃんこ図鑑 Pro</h1>
    <div>
      単位:
      <select id="unit-select" onchange="renderList()">
        <option value="sec">秒</option>
        <option value="f30">フレーム(iOS30fps)</option>
        <option value="f27">フレーム(Android27fps)</option>
      </select>
    </div>
  </header>
  <nav>
    <button onclick="showTab('catalog')">図鑑</button>
    <button onclick="showTab('add')">追加</button>
    <button onclick="exportData()">エクスポート</button>
    <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    <button onclick="document.getElementById('importFile').click()">インポート</button>
  </nav>

  <div id="catalog" class="tab active">
    <h2>図鑑</h2>
    <div id="cat-list"></div>
  </div>

  <div id="add" class="tab">
    <h2>キャラ追加</h2>
    <input type="hidden" id="editIndex">
    <div class="row">
      <input id="no" placeholder="No.">
      <input id="name" placeholder="キャラ名">
      <select id="rarity">
        <option>基本</option><option>EX</option><option>レア</option>
        <option>激レア</option><option>超激レア</option><option>伝説レア</option>
      </select>
    </div>
    <textarea id="desc" placeholder="キャラ説明"></textarea>

    <!-- 形態 -->
    <div id="forms"></div>

    <button onclick="saveCat()">保存</button>
  </div>

  <!-- モーダル -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2 id="m-name"></h2>
      <div id="tabs"></div>
      <div id="form-detail"></div>
      <button onclick="closeModal()">閉じる</button>
    </div>
  </div>

<script>
let cats=[];
const MAX_FORMS=4;
const UNIT=()=>document.getElementById("unit-select").value;
function toFrames(sec,fps){return (sec*fps).toFixed(1);}
function toSec(frames,fps){return (frames/fps).toFixed(2);}
function showTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
window.onload=()=>{
  const saved=localStorage.getItem("cats");
  if(saved) cats=JSON.parse(saved);
  renderList();
  renderFormInputs();
};
function renderFormInputs(){
  const formsDiv=document.getElementById("forms");
  formsDiv.innerHTML="";
  for(let i=1;i<=MAX_FORMS;i++){
    formsDiv.innerHTML+=`
    <div class="form-block">
      <h3>第${i}形態</h3>
      <input type="file" accept="image/*" onchange="handleImageUpload(event,${i})"><br>
      <img id="preview${i}" style="width:60px;height:60px"><br>
      <div class="row">
        <input id="hp${i}" type="number" placeholder="体力">
        <input id="atk${i}" type="number" placeholder="攻撃力">
        <input id="range${i}" type="number" placeholder="射程">
        <input id="cost${i}" type="number" placeholder="コスト">
      </div>
      <div class="row">
        <input id="kb${i}" type="number" placeholder="KB数">
        <input id="speed${i}" type="number" placeholder="移動速度">
        <input id="respawn${i}" type="number" placeholder="最生産時間(秒)">
      </div>
      <div class="row">
        <input id="startup${i}" type="number" placeholder="攻撃発生(秒)">
        <input id="interval${i}" type="number" placeholder="攻撃頻度(秒)">
      </div>
      <div id="traits${i}"></div>
      <button onclick="addTrait(${i})">特性追加</button>
      <textarea id="ability${i}" placeholder="能力"></textarea>
      <textarea id="attribute${i}" placeholder="対応属性"></textarea>
    </div>`;
  }
}
function handleImageUpload(e,i){
  const file=e.target.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=()=>{document.getElementById("preview"+i).src=reader.result;};
  reader.readAsDataURL(file);
}
function addTrait(formIndex){
  const div=document.getElementById("traits"+formIndex);
  const id=Date.now();
  div.insertAdjacentHTML("beforeend",`
    <div class="row trait" data-id="${id}">
      <input placeholder="特性名">
      <input type="number" placeholder="確率(%)">
      <input type="number" placeholder="効果時間(秒)">
      <input type="number" placeholder="レベル">
      <button onclick="this.parentElement.remove()">✕</button>
    </div>`);
}
function saveCat(){
  const idx=document.getElementById("editIndex").value;
  const name=document.getElementById("name").value;
  if(!name)return alert("名前必須");
  const cat={no:document.getElementById("no").value,name,rarity:document.getElementById("rarity").value,
             desc:document.getElementById("desc").value,forms:[]};
  for(let i=1;i<=MAX_FORMS;i++){
    const form={
      icon:document.getElementById("preview"+i).src||"",
      hp:+document.getElementById("hp"+i).value||null,
      atk:+document.getElementById("atk"+i).value||null,
      range:+document.getElementById("range"+i).value||null,
      cost:+document.getElementById("cost"+i).value||null,
      kb:+document.getElementById("kb"+i).value||null,
      speed:+document.getElementById("speed"+i).value||null,
      respawn:+document.getElementById("respawn"+i).value||null,
      startup:+document.getElementById("startup"+i).value||null,
      interval:+document.getElementById("interval"+i).value||null,
      ability:document.getElementById("ability"+i).value,
      attribute:document.getElementById("attribute"+i).value,
      traits:[]
    };
    document.querySelectorAll(`#traits${i} .trait`).forEach(tr=>{
      const t=tr.querySelectorAll("input");
      form.traits.push({name:t[0].value,prob:+t[1].value||null,duration:+t[2].value||null,lv:+t[3].value||null});
    });
    cat.forms.push(form);
  }
  if(idx!==""){cats[idx]=cat;} else cats.push(cat);
  localStorage.setItem("cats",JSON.stringify(cats));
  renderList(); showTab('catalog');
}
function renderList(){
  const list=document.getElementById("cat-list"); list.innerHTML="";
  cats.forEach((c,i)=>{
    const card=document.createElement("div"); card.className="cat-card";
    card.innerHTML=`<div style="display:flex;align-items:center">
      <img src="${c.forms[0].icon||'https://via.placeholder.com/50'}">
      <div><b>No.${c.no||''} ${c.name}</b><br><small>${c.rarity}</small></div>
    </div>
    <div><button onclick="openModal(${i})">詳細</button></div>`;
    list.appendChild(card);
  });
}
function openModal(i){
  const cat=cats[i];
  document.getElementById("m-name").innerText=`No.${cat.no||''} ${cat.name}`;
  const tabs=document.getElementById("tabs"); tabs.innerHTML="";
  const detail=document.getElementById("form-detail"); detail.innerHTML="";
  cat.forms.forEach((f,idx)=>{
    const b=document.createElement("button"); b.className="tab-btn"; b.innerText=`第${idx+1}形態`;
    b.onclick=()=>showForm(f,idx); tabs.appendChild(b);
  });
  showForm(cat.forms[0],0);
  document.getElementById("modal").style.display="flex";
}
function showForm(f,idx){
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".tab-btn")[idx].classList.add("active");
  const u=UNIT(); const fps=(u==="f30"?30:(u==="f27"?27:null));
  const conv=(v)=>{if(v==null)return"-"; if(u==="sec")return v+"秒"; return toFrames(v,fps)+"f";};
  let html=`<img src="${f.icon||'https://via.placeholder.com/100'}"><table>`;
  html+=`<tr><td>体力</td><td>${f.hp||"-"}</td></tr>
         <tr><td>攻撃力</td><td>${f.atk||"-"}</td></tr>
         <tr><td>射程</td><td>${f.range||"-"}</td></tr>
         <tr><td>コスト</td><td>${f.cost||"-"}</td></tr>
         <tr><td>KB数</td><td>${f.kb||"-"}</td></tr>
         <tr><td>移動速度</td><td>${f.speed||"-"}</td></tr>
         <tr><td>最生産時間</td><td>${f.respawn||"-"}秒</td></tr>
         <tr><td>攻撃発生</td><td>${conv(f.startup)}</td></tr>
         <tr><td>攻撃頻度</td><td>${conv(f.interval)}</td></tr>
         <tr><td>能力</td><td>${f.ability||""}</td></tr>
         <tr><td>対応属性</td><td>${f.attribute||""}</td></tr>`;
  html+="</table>";
  if(f.traits&&f.traits.length){html+="<div class='traits'><b>特性</b><ul>";
    f.traits.forEach(t=>{
      html+=`<li>${t.name} ${t.prob||""}% Lv${t.lv||""} ${t.duration?(conv(t.duration)):""}</li>`;
    }); html+="</ul></div>";
  }
  document.getElementById("form-detail").innerHTML=html;
}
function closeModal(){document.getElementById("modal").style.display="none";}
function exportData(){
  const blob=new Blob([JSON.stringify(cats)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="nyanko.json"; a.click();
}
function importData(e){
  const file=e.target.files[0]; if(!file)return;
  const reader=new FileReader(); reader.onload=()=>{cats=JSON.parse(reader.result); localStorage.setItem("cats",reader.result); renderList();};
  reader.readAsText(file);
}
</script>
</body>
</html>
