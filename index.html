<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>にゃんこ図鑑 Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- ホーム画面追加用 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="にゃんこ図鑑">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #121212;
      color: #fff;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      background: #1e1e1e;
    }
    header h1 { font-size: 18px; margin: 0; }
    header button { background: none; border: none; color: #fff; font-size: 18px; cursor: pointer; }
    nav { display: flex; }
    nav button {
      flex: 1; padding: 8px; border: none; cursor: pointer;
      background: #1e1e1e; color: #fff; font-weight: bold;
    }
    nav button.active { background: #333; }
    .tab { display: none; padding: 10px; }
    .tab.active { display: block; }
    input, select, textarea {
      background: #1e1e1e; color: #fff; border: 1px solid #555;
      padding: 4px; margin: 2px 0; width: 100%;
    }
    .form-section { border: 1px solid #333; padding: 8px; margin-bottom: 8px; }
    .save-btn {
      background: #444; color: #fff; font-size: 18px;
      padding: 12px; border: none; cursor: pointer; width: 100%;
    }
    .card { background: #1e1e1e; margin: 6px 0; padding: 6px; border: 1px solid #333; }
    .card img { width: 50px; height: 50px; object-fit: cover; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, 100px); gap: 8px; }
    .grid img {
      width: 100px; height: 100px; object-fit: cover; background: #333;
      cursor: pointer; border-radius: 6px;
    }
    .filters { margin-bottom: 10px; }
    .filters input[type="text"] { width: 100%; }
    .rarity-filters { display: flex; flex-wrap: wrap; gap: 6px; margin: 6px 0; }
    .rarity-filters label { font-size: 14px; }
    .modal {
      position: fixed; top: 0; left: 0; right:0; bottom:0;
      background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center;
    }
    .modal-content {
      background: #1e1e1e; padding: 20px; max-height: 90vh; overflow-y: auto; width: 90%; max-width: 600px;
    }
    .modal-content img { max-width: 150px; display:block; margin:0 auto; }
    .modal-content button { margin: 4px; }
  </style>
</head>
<body>
  <header>
    <h1>にゃんこ図鑑 Pro</h1>
    <button id="themeToggle">🌙</button>
  </header>
  <nav>
    <button data-tab="register" class="active">登録</button>
    <button data-tab="catalog">図鑑</button>
    <button data-tab="trash">ゴミ箱</button>
  </nav>

  <!-- 登録タブ -->
  <div id="register" class="tab active">
    <button class="save-btn" onclick="saveCharacter()">保存</button>
    <div id="formContainer"></div>
  </div>

  <!-- 図鑑タブ -->
  <div id="catalog" class="tab">
    <div class="filters">
      <input type="text" id="searchName" placeholder="名前検索">
      <div class="rarity-filters">
        <label><input type="checkbox" value="基本" checked> 基本</label>
        <label><input type="checkbox" value="EX" checked> EX</label>
        <label><input type="checkbox" value="レア" checked> レア</label>
        <label><input type="checkbox" value="激レア" checked> 激レア</label>
        <label><input type="checkbox" value="超激レア" checked> 超激レア</label>
        <label><input type="checkbox" value="伝説レア" checked> 伝説レア</label>
      </div>
      <input type="text" id="searchTrait" placeholder="特性/属性検索 (カンマ区切り)">
      <label><input type="radio" name="logic" value="and" checked> AND</label>
      <label><input type="radio" name="logic" value="or"> OR</label>
      <button onclick="toggleView()">表示切替</button>
    </div>
    <div id="catalogList"></div>
  </div>

  <!-- ゴミ箱タブ -->
  <div id="trash" class="tab">
    <div id="trashList"></div>
  </div>

  <!-- 詳細モーダル -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <div id="detailContent"></div>
      <button onclick="editCurrent()">編集</button>
      <button onclick="deleteCurrent()">削除</button>
      <button onclick="closeModal()">閉じる</button>
    </div>
  </div>

<script>
let characters = JSON.parse(localStorage.getItem("characters")||"[]");
let trash = JSON.parse(localStorage.getItem("trash")||"[]");
let currentEdit = null;
let gridView = false;
let fpsMode = 30;
let dark = true;

function showTab(tab){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.getElementById(tab).classList.add("active");
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  document.querySelector(`nav button[data-tab="${tab}"]`).classList.add("active");
  if(tab==="catalog") renderCatalog();
  if(tab==="trash") renderTrash();
  if(tab==="register") buildForm();
}

document.querySelectorAll("nav button").forEach(b=>{
  b.addEventListener("click",()=>showTab(b.dataset.tab));
});

function buildForm(char){
  let html = "";
  for(let i=0;i<4;i++){
    let f = char?.forms?.[i] || {};
    html += `<div class="form-section">
      <h3>第${i+1}形態</h3>
      <input placeholder="形態名" id="form${i}Name" value="${f.name||""}">
      <textarea placeholder="説明 (Markdown対応)" id="form${i}Desc">${f.desc||""}</textarea>
      <input type="file" accept="image/*" id="form${i}Img">
      <input placeholder="体力" id="form${i}HP" value="${f.hp||""}">
      <input placeholder="攻撃力" id="form${i}Atk" value="${f.atk||""}">
      <input placeholder="射程" id="form${i}Range" value="${f.range||""}">
      <input placeholder="DPS" id="form${i}DPS" value="${f.dps||""}">
      <input placeholder="コスト" id="form${i}Cost" value="${f.cost||""}">
      <input placeholder="KB数" id="form${i}KB" value="${f.kb||""}">
      <input placeholder="移動速度" id="form${i}Spd" value="${f.spd||""}">
      <input placeholder="再生産時間" id="form${i}Resp" value="${f.resp||""}">
      <input placeholder="攻撃発生" id="form${i}Start" value="${f.start||""}">
      <input placeholder="攻撃頻度" id="form${i}Freq" value="${f.freq||""}">
    </div>`;
  }
  document.getElementById("formContainer").innerHTML = html;
}

function saveCharacter(){
  let char = { forms: [] , rarity:"レア"};
  for(let i=0;i<4;i++){
    char.forms.push({
      name:document.getElementById(`form${i}Name`).value,
      desc:document.getElementById(`form${i}Desc`).value,
      hp:document.getElementById(`form${i}HP`).value,
      atk:document.getElementById(`form${i}Atk`).value,
      range:document.getElementById(`form${i}Range`).value,
      dps:document.getElementById(`form${i}DPS`).value,
      cost:document.getElementById(`form${i}Cost`).value,
      kb:document.getElementById(`form${i}KB`).value,
      spd:document.getElementById(`form${i}Spd`).value,
      resp:document.getElementById(`form${i}Resp`).value,
      start:document.getElementById(`form${i}Start`).value,
      freq:document.getElementById(`form${i}Freq`).value,
    });
  }
  if(currentEdit!==null){ characters[currentEdit]=char; currentEdit=null;}
  else characters.push(char);
  localStorage.setItem("characters",JSON.stringify(characters));
  showTab("catalog");
}

function renderCatalog(){
  let q=document.getElementById("searchName").value.toLowerCase();
  let rarities=[...document.querySelectorAll(".rarity-filters input:checked")].map(i=>i.value);
  let list=document.getElementById("catalogList");
  let arr=characters.filter(c=>{
    let nameMatch=c.forms.some(f=>f.name.toLowerCase().includes(q));
    let rarityMatch=rarities.includes(c.rarity);
    return nameMatch && rarityMatch;
  });
  if(gridView){
    list.className="grid";
    list.innerHTML=arr.map((c,i)=>`<img src="${c.forms[0].img||""}" onclick="openDetail(${i})">`).join("");
  } else {
    list.className="";
    list.innerHTML=arr.map((c,i)=>`<div class="card" onclick="openDetail(${i})"><strong>${c.forms[0].name||"(無名)"}</strong></div>`).join("");
  }
}

function toggleView(){ gridView=!gridView; renderCatalog(); }

function openDetail(i){
  let c=characters[i];
  currentEdit=i;
  let html="";
  c.forms.forEach((f,idx)=>{
    html+=`<h3>第${idx+1}形態 ${f.name||""}</h3>
    ${f.img?`<img src="${f.img}">`:""}
    <p>${f.desc||""}</p>`;
  });
  document.getElementById("detailContent").innerHTML=html;
  document.getElementById("detailModal").style.display="flex";
}

function closeModal(){document.getElementById("detailModal").style.display="none";}
function editCurrent(){buildForm(characters[currentEdit]); showTab("register"); closeModal();}
function deleteCurrent(){
  trash.push({...characters[currentEdit],deleted:Date.now()});
  characters.splice(currentEdit,1);
  localStorage.setItem("characters",JSON.stringify(characters));
  localStorage.setItem("trash",JSON.stringify(trash));
  closeModal(); renderCatalog();
}
function renderTrash(){
  let list=document.getElementById("trashList");
  let now=Date.now();
  trash=trash.filter(c=>now-c.deleted<7*24*60*60*1000);
  localStorage.setItem("trash",JSON.stringify(trash));
  list.innerHTML=trash.map((c,i)=>`<div class="card"><strong>${c.forms[0].name||"(無名)"}</strong>
    <button onclick="restore(${i})">復元</button>
    <button onclick="erase(${i})">完全削除</button></div>`).join("");
}
function restore(i){characters.push(trash[i]);trash.splice(i,1);
  localStorage.setItem("characters",JSON.stringify(characters));
  localStorage.setItem("trash",JSON.stringify(trash));renderTrash();}
function erase(i){trash.splice(i,1);localStorage.setItem("trash",JSON.stringify(trash));renderTrash();}

document.getElementById("themeToggle").onclick=()=>{
  dark=!dark;document.body.style.background=dark?"#121212":"#fff";document.body.style.color=dark?"#fff":"#000";
};

buildForm();
</script>
</body>
</html>
