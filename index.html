<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã«ã‚ƒã‚“ã“å›³é‘‘ Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="ã«ã‚ƒã‚“ã“å›³é‘‘">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    body { background:#121212; color:#fff; font-family:sans-serif; margin:0; }
    header { display:flex; justify-content:space-between; align-items:center; padding:10px; background:#1e1e1e; }
    button { padding:10px 20px; margin:5px; font-size:16px; }
    input, select, textarea { background:#1e1e1e; color:#fff; border:1px solid #444; padding:5px; margin:2px 0; }
    .tab { display:none; padding:10px; }
    .active { display:block; }
    .char-card { background:#1e1e1e; margin:5px 0; padding:10px; border:1px solid #444; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,100px); gap:10px; }
    .grid-item { width:100px; text-align:center; }
    .grid-item img { width:100px; height:100px; object-fit:cover; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); }
    .modal-content { background:#1e1e1e; margin:10% auto; padding:20px; width:90%; max-width:600px; }
  </style>
</head>
<body>
<header>
  <div>
    <button onclick="showTab('register')">ç™»éŒ²</button>
    <button onclick="showTab('catalog')">å›³é‘‘</button>
    <button onclick="showTab('trash')">ã‚´ãƒŸç®±</button>
  </div>
  <div>
    <button onclick="toggleDarkMode()">ğŸŒ™/â˜€ï¸</button>
  </div>
</header>

<!-- ç™»éŒ²ã‚¿ãƒ– -->
<div id="register" class="tab active">
  <h2>ã‚­ãƒ£ãƒ©ç™»éŒ²</h2>
  <label>No:<input type="number" id="charNo"></label>
  <div>
    ãƒ¬ã‚¢ãƒªãƒ†ã‚£:
    <label><input type="checkbox" value="åŸºæœ¬" class="rarity">åŸºæœ¬</label>
    <label><input type="checkbox" value="EX" class="rarity">EX</label>
    <label><input type="checkbox" value="ãƒ¬ã‚¢" class="rarity">ãƒ¬ã‚¢</label>
    <label><input type="checkbox" value="æ¿€ãƒ¬ã‚¢" class="rarity">æ¿€ãƒ¬ã‚¢</label>
    <label><input type="checkbox" value="è¶…æ¿€ãƒ¬ã‚¢" class="rarity">è¶…æ¿€ãƒ¬ã‚¢</label>
    <label><input type="checkbox" value="ä¼èª¬ãƒ¬ã‚¢" class="rarity">ä¼èª¬ãƒ¬ã‚¢</label>
  </div>
  <div>
    è¡¨ç¤ºå˜ä½:
    <select id="unitSelect">
      <option value="sec">ç§’</option>
      <option value="fps30">30fps(iOS)</option>
      <option value="fps27">27fps(Android)</option>
    </select>
  </div>
  <div id="forms"></div>
  <button onclick="saveCharacter()" style="font-size:20px;">ä¿å­˜</button>
</div>

<!-- å›³é‘‘ã‚¿ãƒ– -->
<div id="catalog" class="tab">
  <h2>å›³é‘‘</h2>
  <div>
    åå‰æ¤œç´¢:<input id="searchName">
    ç‰¹æ€§æ¤œç´¢:<input id="searchTrait">
    å±æ€§æ¤œç´¢:<input id="searchAttr">
    <label><input type="radio" name="andor" value="and" checked>AND</label>
    <label><input type="radio" name="andor" value="or">OR</label>
  </div>
  <div>
    ãƒ¬ã‚¢ãƒªãƒ†ã‚£:
    <label><input type="checkbox" class="filter-rarity" value="åŸºæœ¬">åŸºæœ¬</label>
    <label><input type="checkbox" class="filter-rarity" value="EX">EX</label>
    <label><input type="checkbox" class="filter-rarity" value="ãƒ¬ã‚¢">ãƒ¬ã‚¢</label>
    <label><input type="checkbox" class="filter-rarity" value="æ¿€ãƒ¬ã‚¢">æ¿€ãƒ¬ã‚¢</label>
    <label><input type="checkbox" class="filter-rarity" value="è¶…æ¿€ãƒ¬ã‚¢">è¶…æ¿€ãƒ¬ã‚¢</label>
    <label><input type="checkbox" class="filter-rarity" value="ä¼èª¬ãƒ¬ã‚¢">ä¼èª¬ãƒ¬ã‚¢</label>
  </div>
  <div>
    è¡¨ç¤º:<button onclick="setView('list')">ãƒªã‚¹ãƒˆ</button>
         <button onclick="setView('grid')">ã‚°ãƒªãƒƒãƒ‰</button>
    <label><input type="checkbox" id="gridShowNo">ç•ªå·è¡¨ç¤º</label>
  </div>
  <div id="catalogList"></div>
</div>

<!-- ã‚´ãƒŸç®±ã‚¿ãƒ– -->
<div id="trash" class="tab">
  <h2>ã‚´ãƒŸç®±</h2>
  <div id="trashList"></div>
</div>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="detailModal" class="modal">
  <div class="modal-content" id="detailContent"></div>
</div>

<script>
let characters = JSON.parse(localStorage.getItem("nyankoChars")||"[]");
let trash = JSON.parse(localStorage.getItem("nyankoTrash")||"[]");
let editIndex = null;
let viewMode = "list";

function showTab(tab){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.getElementById(tab).classList.add("active");
  if(tab==="catalog") renderCatalog();
  if(tab==="trash") renderTrash();
}

function toggleDarkMode(){
  document.body.style.background = (document.body.style.background==="#121212") ? "#fff":"#121212";
  document.body.style.color = (document.body.style.color==="#fff") ? "#000":"#fff";
}

function initForms(){
  let formsDiv=document.getElementById("forms");
  formsDiv.innerHTML="";
  for(let i=1;i<=4;i++){
    formsDiv.innerHTML+=`
    <fieldset>
      <legend>ç¬¬${i}å½¢æ…‹</legend>
      åå‰:<input id="form${i}Name"><br>
      èª¬æ˜:<textarea id="form${i}Desc"></textarea><br>
      ç”»åƒ:<input type="file" accept="image/*" onchange="previewImage(event,'form${i}ImagePreview')"><br>
      <img id="form${i}ImagePreview" style="width:80px;height:80px;"><br>
      ä½“åŠ›:<input type="number" id="form${i}HP"><br>
      æ”»æ’ƒåŠ›:<input type="number" id="form${i}Atk"><br>
      å°„ç¨‹:<input type="number" id="form${i}Range"><br>
      DPS:<input type="number" id="form${i}DPS"><br>
      ã‚³ã‚¹ãƒˆ:<input type="number" id="form${i}Cost"><br>
      KB:<input type="number" id="form${i}KB"><br>
      ç§»å‹•é€Ÿåº¦:<input type="number" id="form${i}Speed"><br>
      å†ç”Ÿç”£:<input type="number" id="form${i}Respawn"><br>
      æ”»æ’ƒç™ºç”Ÿ:<input type="number" id="form${i}Start"><br>
      æ”»æ’ƒé »åº¦:<input type="number" id="form${i}Freq"><br>
      å±æ€§:<input id="form${i}Attr"><br>
      ç‰¹æ€§:<div id="traits${i}"></div>
      <button type="button" onclick="addTrait(${i})">ç‰¹æ€§è¿½åŠ </button>
    </fieldset>`;
  }
}
initForms();

function previewImage(event,id){
  let reader=new FileReader();
  reader.onload=function(e){ document.getElementById(id).src=e.target.result; }
  reader.readAsDataURL(event.target.files[0]);
}

function addTrait(i){
  let div=document.getElementById("traits"+i);
  div.innerHTML+=`<div>
    åç§°:<input class="traitName">
    ç¢ºç‡:<input type="number" class="traitChance">%
    åŠ¹æœæ™‚é–“:<input type="number" class="traitDuration">ç§’
    å±æ€§:<input class="traitAttr">
  </div>`;
}

function collectTraits(i){
  let traits=[];
  document.querySelectorAll(`#traits${i} div`).forEach(d=>{
    traits.push({
      name:d.querySelector(".traitName").value,
      chance:d.querySelector(".traitChance").value,
      duration:d.querySelector(".traitDuration").value,
      attr:d.querySelector(".traitAttr").value
    });
  });
  return traits;
}

function saveCharacter(){
  let char={ no:document.getElementById("charNo").value, rarities:[], forms:[] };
  document.querySelectorAll(".rarity:checked").forEach(r=>char.rarities.push(r.value));
  for(let i=1;i<=4;i++){
    let atk=+document.getElementById(`form${i}Atk`).value||0;
    let freq=+document.getElementById(`form${i}Freq`).value||1;
    let dps=+document.getElementById(`form${i}DPS`).value||Math.floor(atk/freq);
    char.forms.push({
      name:document.getElementById(`form${i}Name`).value,
      desc:document.getElementById(`form${i}Desc`).value,
      image:document.getElementById(`form${i}ImagePreview`).src,
      hp:document.getElementById(`form${i}HP`).value,
      atk:atk,
      range:document.getElementById(`form${i}Range`).value,
      dps:dps,
      cost:document.getElementById(`form${i}Cost`).value,
      kb:document.getElementById(`form${i}KB`).value,
      speed:document.getElementById(`form${i}Speed`).value,
      respawn:document.getElementById(`form${i}Respawn`).value,
      start:document.getElementById(`form${i}Start`).value,
      freq:freq,
      attr:document.getElementById(`form${i}Attr`).value,
      traits:collectTraits(i)
    });
  }
  if(editIndex!==null){ characters[editIndex]=char; editIndex=null; }
  else characters.push(char);
  saveData(); showTab("catalog");
}

function saveData(){
  localStorage.setItem("nyankoChars",JSON.stringify(characters));
  localStorage.setItem("nyankoTrash",JSON.stringify(trash));
}

function renderCatalog(){
  let list=document.getElementById("catalogList");
  list.innerHTML="";
  if(viewMode==="list"){
    characters.forEach((c,i)=>{
      list.innerHTML+=`<div class="char-card">
        No.${c.no} ${c.forms[0].name||""}
        <button onclick="editChar(${i})">ç·¨é›†</button>
        <button onclick="deleteChar(${i})">å‰Šé™¤</button>
      </div>`;
    });
  } else {
    list.className="grid";
    characters.forEach((c,i)=>{
      list.innerHTML+=`<div class="grid-item" onclick="showDetail(${i})">
        <img src="${c.forms[0].image||""}">
        ${document.getElementById("gridShowNo").checked?("No."+c.no):""}
      </div>`;
    });
  }
}

function setView(mode){ viewMode=mode; renderCatalog(); }

function editChar(i){
  let c=characters[i]; editIndex=i; showTab("register");
  document.getElementById("charNo").value=c.no;
  document.querySelectorAll(".rarity").forEach(r=>r.checked=c.rarities.includes(r.value));
  for(let j=1;j<=4;j++){
    let f=c.forms[j-1];
    if(!f) continue;
    document.getElementById(`form${j}Name`).value=f.name;
    document.getElementById(`form${j}Desc`).value=f.desc;
    document.getElementById(`form${j}ImagePreview`).src=f.image;
    document.getElementById(`form${j}HP`).value=f.hp;
    document.getElementById(`form${j}Atk`).value=f.atk;
    document.getElementById(`form${j}Range`).value=f.range;
    document.getElementById(`form${j}DPS`).value=f.dps;
    document.getElementById(`form${j}Cost`).value=f.cost;
    document.getElementById(`form${j}KB`).value=f.kb;
    document.getElementById(`form${j}Speed`).value=f.speed;
    document.getElementById(`form${j}Respawn`).value=f.respawn;
    document.getElementById(`form${j}Start`).value=f.start;
    document.getElementById(`form${j}Freq`).value=f.freq;
    document.getElementById(`form${j}Attr`).value=f.attr;
    document.getElementById(`traits${j}`).innerHTML="";
    f.traits.forEach(t=>{
      document.getElementById(`traits${j}`).innerHTML+=`<div>
        åç§°:<input class="traitName" value="${t.name}">
        ç¢ºç‡:<input type="number" class="traitChance" value="${t.chance}">%
        åŠ¹æœæ™‚é–“:<input type="number" class="traitDuration" value="${t.duration}">ç§’
        å±æ€§:<input class="traitAttr" value="${t.attr}">
      </div>`;
    });
  }
}

function deleteChar(i){
  trash.push({...characters[i],deleted:Date.now()});
  characters.splice(i,1); saveData(); renderCatalog();
}

function renderTrash(){
  let list=document.getElementById("trashList"); list.innerHTML="";
  let now=Date.now();
  trash=trash.filter(c=>(now-c.deleted)<7*24*60*60*1000);
  trash.forEach((c,i)=>{
    list.innerHTML+=`<div class="char-card">
      No.${c.no} ${c.forms[0].name||""}
      <button onclick="restoreChar(${i})">å¾©å…ƒ</button>
      <button onclick="purgeChar(${i})">å®Œå…¨å‰Šé™¤</button>
    </div>`;
  });
  saveData();
}
function restoreChar(i){ characters.push(trash[i]); trash.splice(i,1); saveData(); renderTrash(); }
function purgeChar(i){ trash.splice(i,1); saveData(); renderTrash(); }

function showDetail(i){
  let c=characters[i];
  let modal=document.getElementById("detailModal");
  let html=`<h3>No.${c.no} ${c.forms[0].name||""}</h3>`;
  c.forms.forEach((f,idx)=>{
    if(!f.name) return;
    html+=`<h4>ç¬¬${idx+1}å½¢æ…‹ ${f.name}</h4>
      <img src="${f.image||""}" style="width:100px;height:100px"><br>
      ä½“åŠ›:${f.hp} æ”»æ’ƒ:${f.atk} DPS:${f.dps}<br>
      å°„ç¨‹:${f.range} ã‚³ã‚¹ãƒˆ:${f.cost} KB:${f.kb}<br>
      ç§»å‹•é€Ÿåº¦:${f.speed} å†ç”Ÿç”£:${f.respawn}<br>
      æ”»æ’ƒç™ºç”Ÿ:${f.start} æ”»æ’ƒé »åº¦:${f.freq}<br>
      å±æ€§:${f.attr}<br>
      <p>${f.desc.replace(/\\n/g,"<br>")}</p>
      <ul>${f.traits.map(t=>`<li>${t.name} ${t.chance}% ${t.duration}ç§’ å±æ€§:${t.attr}</li>`).join("")}</ul>`;
  });
  html+=`<button onclick="editChar(${i});closeModal()">ç·¨é›†</button>
         <button onclick="deleteChar(${i});closeModal()">å‰Šé™¤</button>`;
  document.getElementById("detailContent").innerHTML=html
