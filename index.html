<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã«ã‚ƒã‚“ã“å›³é‘‘ Pro å®Œå…¨ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="ã«ã‚ƒã‚“ã“å›³é‘‘">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    body { background:#121212; color:#fff; font-family:sans-serif; margin:0; }
    header { display:flex; justify-content:space-between; align-items:center; padding:10px; background:#1e1e1e; }
    header h1 { font-size:18px; margin:0; }
    nav button { margin:0 2px; padding:6px 12px; font-size:14px; }
    .dark { background:#121212; color:#fff; }
    .light { background:#fff; color:#000; }
    .hidden { display:none; }
    .form-section { padding:10px; }
    .form-section input, .form-section textarea, .form-section select { width:100%; margin:4px 0; padding:6px; }
    .big-btn { font-size:18px; padding:10px; width:100%; margin:10px 0; }
    .catalog { padding:10px; }
    .list-view .card { background:#1e1e1e; padding:8px; margin:4px 0; border-radius:4px; }
    .grid-view { display:grid; grid-template-columns:repeat(auto-fill,100px); gap:8px; }
    .grid-view .card { background:#1e1e1e; width:100px; height:120px; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .grid-view img { width:100px; height:100px; object-fit:cover; }
    .card img { max-width:80px; max-height:80px; }
    .modal { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; }
    .modal-content { background:#1e1e1e; padding:20px; border-radius:6px; max-height:80%; overflow:auto; }
    .trash { padding:10px; }
    .trait { display:flex; gap:4px; margin:2px 0; }
    .filters { padding:10px; background:#1e1e1e; }
  </style>
</head>
<body>
  <header>
    <h1>ã«ã‚ƒã‚“ã“å›³é‘‘ Pro</h1>
    <div>
      <button onclick="toggleDark()">ğŸŒ™/â˜€ï¸</button>
      <button onclick="showTab('register')">ç™»éŒ²</button>
      <button onclick="showTab('catalog')">å›³é‘‘</button>
      <button onclick="showTab('trash')">ã‚´ãƒŸç®±</button>
    </div>
  </header>

  <!-- ç™»éŒ²ç”»é¢ -->
  <section id="register" class="form-section">
    <button class="big-btn" onclick="saveCharacter()">ä¿å­˜</button>
    <label>No:<input id="charNo" type="text"></label>
    <label>åå‰:<input id="charName" type="text"></label>
    <div>
      ãƒ¬ã‚¢ãƒªãƒ†ã‚£:
      <label><input type="checkbox" name="rarity" value="åŸºæœ¬">åŸºæœ¬</label>
      <label><input type="checkbox" name="rarity" value="EX">EX</label>
      <label><input type="checkbox" name="rarity" value="ãƒ¬ã‚¢">ãƒ¬ã‚¢</label>
      <label><input type="checkbox" name="rarity" value="æ¿€ãƒ¬ã‚¢">æ¿€ãƒ¬ã‚¢</label>
      <label><input type="checkbox" name="rarity" value="è¶…æ¿€ãƒ¬ã‚¢">è¶…æ¿€ãƒ¬ã‚¢</label>
      <label><input type="checkbox" name="rarity" value="ä¼èª¬ãƒ¬ã‚¢">ä¼èª¬ãƒ¬ã‚¢</label>
    </div>

    <div id="forms"></div>
  </section>

  <!-- å›³é‘‘ç”»é¢ -->
  <section id="catalog" class="catalog hidden">
    <div class="filters">
      <input id="searchName" placeholder="åå‰æ¤œç´¢">
      <input id="searchTrait" placeholder="ç‰¹æ€§æ¤œç´¢">
      <label><input type="radio" name="mode" value="AND" checked>AND</label>
      <label><input type="radio" name="mode" value="OR">OR</label>
      <div>
        ãƒ¬ã‚¢ãƒªãƒ†ã‚£:
        <label><input type="checkbox" class="filterRarity" value="åŸºæœ¬">åŸºæœ¬</label>
        <label><input type="checkbox" class="filterRarity" value="EX">EX</label>
        <label><input type="checkbox" class="filterRarity" value="ãƒ¬ã‚¢">ãƒ¬ã‚¢</label>
        <label><input type="checkbox" class="filterRarity" value="æ¿€ãƒ¬ã‚¢">æ¿€ãƒ¬ã‚¢</label>
        <label><input type="checkbox" class="filterRarity" value="è¶…æ¿€ãƒ¬ã‚¢">è¶…æ¿€ãƒ¬ã‚¢</label>
        <label><input type="checkbox" class="filterRarity" value="ä¼èª¬ãƒ¬ã‚¢">ä¼èª¬ãƒ¬ã‚¢</label>
      </div>
      <button onclick="toggleView()">è¡¨ç¤ºåˆ‡æ›¿</button>
      <label><input type="checkbox" id="showNumbers">ç•ªå·ã‚’è¡¨ç¤º(ã‚°ãƒªãƒƒãƒ‰)</label>
    </div>
    <div id="catalogList" class="list-view"></div>
  </section>

  <!-- ã‚´ãƒŸç®±ç”»é¢ -->
  <section id="trash" class="trash hidden"></section>

  <div id="modal" class="modal"><div class="modal-content" id="modalContent"></div></div>

<script>
let characters = JSON.parse(localStorage.getItem("characters")||"[]");
let trash = JSON.parse(localStorage.getItem("trash")||"[]");
let editIndex = null;
let gridView = false;

// åˆæœŸåŒ–
document.addEventListener("DOMContentLoaded", ()=>{
  renderForms();
  renderCatalog();
  cleanupTrash();
});

// ã‚¿ãƒ–åˆ‡æ›¿
function showTab(tab){
  document.getElementById("register").classList.add("hidden");
  document.getElementById("catalog").classList.add("hidden");
  document.getElementById("trash").classList.add("hidden");
  document.getElementById(tab).classList.remove("hidden");
  if(tab=="catalog") renderCatalog();
  if(tab=="trash") renderTrash();
}

// ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰
function toggleDark(){
  document.body.classList.toggle("light");
}

// å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ç”Ÿæˆ
function renderForms(){
  let html="";
  for(let i=1;i<=4;i++){
    html+=`
    <fieldset>
      <legend>ç¬¬${i}å½¢æ…‹</legend>
      <input id="form${i}Name" placeholder="å½¢æ…‹å">
      <textarea id="form${i}Desc" placeholder="èª¬æ˜ (Markdownå¯¾å¿œ)"></textarea>
      <input type="file" id="form${i}Image" onchange="previewImage(event,${i})">
      <img id="form${i}ImagePreview" style="max-width:100px;max-height:100px;">
      <input id="form${i}HP" placeholder="ä½“åŠ›">
      <input id="form${i}Atk" placeholder="æ”»æ’ƒåŠ›">
      <input id="form${i}Range" placeholder="å°„ç¨‹">
      <input id="form${i}DPS" placeholder="DPS">
      <input id="form${i}Cost" placeholder="ã‚³ã‚¹ãƒˆ">
      <input id="form${i}KB" placeholder="KBæ•°">
      <input id="form${i}Speed" placeholder="ç§»å‹•é€Ÿåº¦">
      <input id="form${i}Respawn" placeholder="å†ç”Ÿç”£æ™‚é–“(ç§’)">
      <input id="form${i}Startup" placeholder="æ”»æ’ƒç™ºç”Ÿ(ç§’)">
      <input id="form${i}Interval" placeholder="æ”»æ’ƒé »åº¦(ç§’)">
      <div id="traits${i}"></div>
      <button type="button" onclick="addTrait(${i})">ç‰¹æ€§è¿½åŠ </button>
    </fieldset>`;
  }
  document.getElementById("forms").innerHTML=html;
}

function previewImage(e,i){
  let reader=new FileReader();
  reader.onload=()=>{ document.getElementById(`form${i}ImagePreview`).src=reader.result; };
  reader.readAsDataURL(e.target.files[0]);
}

// ç‰¹æ€§è¿½åŠ 
function addTrait(i){
  let div=document.createElement("div");
  div.className="trait";
  div.innerHTML=`
    <input placeholder="ç‰¹æ€§å">
    <input type="number" placeholder="%">
    <input placeholder="åŠ¹æœæ™‚é–“(ç§’)">
    <input placeholder="Lv">`;
  document.getElementById("traits"+i).appendChild(div);
}

function collectTraits(i){
  let traits=[];
  document.querySelectorAll(`#traits${i} .trait`).forEach(tr=>{
    traits.push({
      name: tr.children[0].value,
      prob: tr.children[1].value,
      duration: tr.children[2].value,
      level: tr.children[3].value
    });
  });
  return traits;
}

// ä¿å­˜å‡¦ç†
function saveCharacter(){
  let char={
    no: document.getElementById("charNo").value,
    name: document.getElementById("charName").value,
    rarity: Array.from(document.querySelectorAll("input[name=rarity]:checked")).map(r=>r.value),
    forms:[]
  };
  for(let i=1;i<=4;i++){
    char.forms.push({
      formName: document.getElementById(`form${i}Name`).value,
      formDesc: document.getElementById(`form${i}Desc`).value,
      image: document.getElementById(`form${i}ImagePreview`).src,
      hp: document.getElementById(`form${i}HP`).value,
      atk: document.getElementById(`form${i}Atk`).value,
      range: document.getElementById(`form${i}Range`).value,
      dps: document.getElementById(`form${i}DPS`).value,
      cost: document.getElementById(`form${i}Cost`).value,
      kb: document.getElementById(`form${i}KB`).value,
      speed: document.getElementById(`form${i}Speed`).value,
      respawn: document.getElementById(`form${i}Respawn`).value,
      startup: document.getElementById(`form${i}Startup`).value,
      interval: document.getElementById(`form${i}Interval`).value,
      traits: collectTraits(i)
    });
  }
  if(editIndex!==null){
    characters[editIndex]=char;
    editIndex=null;
  }else{
    characters.push(char);
  }
  saveData();
  showTab("catalog");
}

// ãƒ‡ãƒ¼ã‚¿ä¿å­˜
function saveData(){
  localStorage.setItem("characters",JSON.stringify(characters));
  localStorage.setItem("trash",JSON.stringify(trash));
}

// ã‚«ã‚¿ãƒ­ã‚°è¡¨ç¤º
function renderCatalog(){
  let container=document.getElementById("catalogList");
  container.innerHTML="";
  container.className=gridView?"grid-view":"list-view";
  let searchName=document.getElementById("searchName").value;
  let searchTrait=document.getElementById("searchTrait").value;
  let rarities=Array.from(document.querySelectorAll(".filterRarity:checked")).map(r=>r.value);
  let mode=document.querySelector("input[name=mode]:checked").value;
  let showNumbers=document.getElementById("showNumbers").checked;

  characters.forEach((c,idx)=>{
    // ãƒ•ã‚£ãƒ«ã‚¿å‡¦ç†
    if(searchName && !c.name.includes(searchName)) return;
    if(rarities.length>0 && !rarities.some(r=>c.rarity.includes(r))) return;
    if(searchTrait){
      let traits=c.forms.flatMap(f=>f.traits.map(t=>t.name));
      if(mode=="AND" && !traits.includes(searchTrait)) return;
      if(mode=="OR" && traits.length && !traits.some(t=>t.includes(searchTrait))) return;
    }

    let card=document.createElement("div");
    card.className="card";
    if(gridView){
      let img=document.createElement("img");
      img.src=c.forms[0].image||"";
      card.appendChild(img);
      if(showNumbers) card.innerHTML+=`<div>No.${c.no||""}</div>`;
      card.onclick=()=>showDetail(c,idx);
    }else{
      card.innerHTML=`No.${c.no||""} ${c.name} <button onclick="editCharacter(${idx})">ç·¨é›†</button> <button onclick="deleteCharacter(${idx})">å‰Šé™¤</button>`;
    }
    container.appendChild(card);
  });
}

function toggleView(){ gridView=!gridView; renderCatalog(); }

// è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
function showDetail(c,idx){
  let modal=document.getElementById("modal");
  let html=`<h2>No.${c.no} ${c.name}</h2>`;
  c.forms.forEach((f,i)=>{
    html+=`<h3>ç¬¬${i+1}å½¢æ…‹ ${f.formName}</h3>
      <img src="${f.image}" style="max-width:100px"><p>${f.formDesc}</p>
      <ul><li>ä½“åŠ›:${f.hp}</li><li>æ”»æ’ƒ:${f.atk}</li><li>DPS:${f.dps}</li></ul>`;
  });
  html+=`<button onclick="editCharacter(${idx})">ç·¨é›†</button>
         <button onclick="deleteCharacter(${idx})">å‰Šé™¤</button>`;
  document.getElementById("modalContent").innerHTML=html;
  modal.style.display="flex";
  modal.onclick=()=>modal.style.display="none";
}

// ç·¨é›†
function editCharacter(idx){
  let c=characters[idx];
  document.getElementById("charNo").value=c.no;
  document.getElementById("charName").value=c.name;
  document.querySelectorAll("input[name=rarity]").forEach(r=>r.checked=c.rarity.includes(r.value));
  c.forms.forEach((f,i)=>{
    document.getElementById(`form${i+1}Name`).value=f.formName;
    document.getElementById(`form${i+1}Desc`).value=f.formDesc;
    document.getElementById(`form${i+1}ImagePreview`).src=f.image;
    document.getElementById(`form${i+1}HP`).value=f.hp;
    document.getElementById(`form${i+1}Atk`).value=f.atk;
    document.getElementById(`form${i+1}Range`).value=f.range;
    document.getElementById(`form${i+1}DPS`).value=f.dps;
    document.getElementById(`form${i+1}Cost`).value=f.cost;
    document.getElementById(`form${i+1}KB`).value=f.kb;
    document.getElementById(`form${i+1}Speed`).value=f.speed;
    document.getElementById(`form${i+1}Respawn`).value=f.respawn;
    document.getElementById(`form${i+1}Startup`).value=f.startup;
    document.getElementById(`form${i+1}Interval`).value=f.interval;
    document.getElementById(`traits${i+1}`).innerHTML="";
    f.traits.forEach(t=>{
      let div=document.createElement("div");
      div.className="trait";
      div.innerHTML=`<input value="${t.name}"><input value="${t.prob}"><input value="${t.duration}"><input value="${t.level}">`;
      document.getElementById(`traits${i+1}`).appendChild(div);
    });
  });
  editIndex=idx;
  showTab("register");
}

// å‰Šé™¤â†’ã‚´ãƒŸç®±
function deleteCharacter(idx){
  let c=characters.splice(idx,1)[0];
  c.deletedAt=Date.now();
  trash.push(c);
  saveData();
  renderCatalog();
}

// ã‚´ãƒŸç®±è¡¨ç¤º
function renderTrash(){
  let div=document.getElementById("trash");
  div.innerHTML="";
  trash.forEach((c,idx)=>{
    div.innerHTML+=`<div>No.${c.no} ${c.name}
      <button onclick="restore(${idx})">å¾©å…ƒ</button>
      <button onclick="purge(${idx})">å®Œå…¨å‰Šé™¤</button></div>`;
  });
}

// å¾©å…ƒ
function restore(idx){
  let c=trash.splice(idx,1)[0];
  delete c.deletedAt;
  characters.push(c);
  saveData();
  renderTrash();
}

// å®Œå…¨å‰Šé™¤
function purge(idx){
  trash.splice(idx,1);
  saveData();
  renderTrash();
}

// 7æ—¥ã§è‡ªå‹•å‰Šé™¤
function cleanupTrash(){
  let now=Date.now();
  trash=trash.filter(c=>now-c.deletedAt<7*24*60*60*1000);
  saveData();
}
</script>
</body>
</html>
